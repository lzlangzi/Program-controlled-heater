#include "OLED_IIC.h"
#include "CodeDat.h"
#include "transform.h"

const unsigned char BMP3[] =
{
0x08,0x02,0x07,0x07,0x2F,0x2E,0x1E,0x1F,0xDD,0xBD,0xBB,0x73,0x77,0x75,0xE7,0xEF,
0xD0,0xC0,0xA0,0x90,0x10,0x00,0x30,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x60,0xA0,0xA0,0xB0,0xB0,0xA0,0x60,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFD,0xF5,0xEB,0xC3,0xEF,0xAF,0xBF,0x7E,0x7E,0xFF,0xFF,0xFE,0xFE,0xFE,0xFE,0xFF,
0xFF,0xFF,0xFF,0xFF,0xF9,0xF5,0xF6,0xEF,0xE0,0xD0,0xD0,0xD0,0xB0,0xB0,0x70,0x70,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0E,0x0E,0x01,0x0D,0x09,0x0B,0x0B,
0x17,0x07,0x0F,0xAF,0xDF,0xDF,0xDF,0xBF,0xBF,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFE,0xFE,0xFF,0xFC,0xF8,0xF9,0xFB,0xF7,0xF0,0xF0,0xE0,0xD0,0xD0,0xC0,0xB0,0x30,
0x80,0x40,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x0F,0x02,0xC2,0xC9,0x49,0x89,
0xBB,0xB3,0xD7,0xD7,0xEF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFE,0xFE,0xFE,0xFD,0xFB,0xFB,0xF8,0xF4,0xF4,0xE4,0xE0,0xE0,0xD0,0xE0,
0xE0,0xF0,0xF0,0xF0,0xF0,0xE0,0x50,0xB0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x90,0x00,0x00,
0x60,0xE0,0xE0,0xE0,0xF4,0xF4,0xF4,0xF8,0xFB,0xF8,0xFC,0xFD,0xFE,0xFE,0xFF,0xFF,
0xFF,0xFF,0x7F,0x7F,0x7F,0xBF,0xBF,0xDF,0xDF,0x5F,0x1F,0x3F,0xA7,0x77,0x57,0xE7,
0xAF,0xAF,0xBF,0xDF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0xFD,0xFD,0xE8,0xE4,0xDC,0xBC,0x90,0x70,0x70,0xF0,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x0E,0x0C,0x09,0x07,0x0F,0x0F,0x07,0x07,0x07,0x03,0x0B,0x0B,0x0B,0x0D,0x0D,0x0D,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xF0,0x1C,0xDC,0xDC,0xEC,0xF3,0xFC,
0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0xCF,0xB1,0xFC,0x3A,0x36,0x02,0x3D,
0x01,0x01,0x01,0x02,0x02,0x00,0x01,0x01,0x1F,0x0B,0x13,0x6F,0xCF,0xBF,0x3F,0x7E,
0xFE,0xFD,0xFD,0xFD,0xFC,0xF8,0xFA,0xF6,0xF0,0xE0,0xE0,0xE0,0xD0,0xD0,0xB0,0xB0,
0x00,0x00,0x40,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0D,0x08,0x00,0x08,0x0A,0x0D,0x0D,0x0B,
0x0B,0x07,0x07,0x07,0x07,0x0B,0x0D,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x02,0x01,0x03,
0xFB,0x07,0x07,0x0F,0xEF,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFE,0xFE,0xFE,0xFD,0xFD,0xFB,0xFA,0xFB,0xFB,0xF3,0xF0,0xF0,0xE4,0xEC,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0x3F,0x38,0x27,0x1F,0xDF,0xBF,0xBF,0x7F,0x7F,0xFF,0xFF,0xFF,
0xFF,0x7F,0x7F,0x7F,0x3F,0xBF,0xBF,0xDF,0x1F,0x0F,0x2F,0x27,0x07,0x0B,0x09,0x0C,/*"C:\Users\ws\Desktop\BMP7.bmp",0*/
};

/*********************OLED驱动程序用的延时程序************************************/
void delay(unsigned int z)
{
    unsigned int x,y;
	for(x=z;x>0;x--)
	    for(y=110;y>0;y--);
}

/******************************************************************************
****函数功能：IIC产生起始信号函数
****输入参数：无
****输出参数：无
******************************************************************************/
void GPIO_IIC_Start()
{
    GPIO_WriteHigh(IIC_SCL_PORT,IIC_SCL_PINS);   //SCL = high;		
    GPIO_WriteHigh(IIC_SDA_PORT,IIC_SDA_PINS);   //SDA = high;
    GPIO_WriteLow(IIC_SDA_PORT,IIC_SDA_PINS);    //SDA = low;
    GPIO_WriteLow(IIC_SCL_PORT,IIC_SCL_PINS);    //SCL = low;
}

/******************************************************************************
****函数功能：IIC产生停止信号
****输入参数：无
****输出参数：无
******************************************************************************/
void GPIO_IIC_Stop()
{
    GPIO_WriteLow(IIC_SCL_PORT,IIC_SCL_PINS);     //SCL = low;
    GPIO_WriteLow(IIC_SDA_PORT,IIC_SDA_PINS);     //SDA = low;
    GPIO_WriteHigh(IIC_SCL_PORT,IIC_SCL_PINS);    //SCL = high;
    GPIO_WriteHigh(IIC_SDA_PORT,IIC_SDA_PINS);    //SDA = high;
}

/******************************************************************************
****函数功能：IIC发送一个字节
****输入参数：一个字节
****输出参数：无
******************************************************************************/
void GPIO_IIC_SendOneByte(unsigned char IIC_Byte)
{
    unsigned char i;
    for(i = 0; i < 8; i++)
    {
        if(IIC_Byte & 0x80)
            GPIO_WriteHigh(IIC_SDA_PORT,IIC_SDA_PINS);   //SDA=high;
	else
            GPIO_WriteLow(IIC_SDA_PORT,IIC_SDA_PINS);   //SDA=low;
	GPIO_WriteHigh(IIC_SCL_PORT,IIC_SCL_PINS);      //SCL=high;
	GPIO_WriteLow(IIC_SCL_PORT,IIC_SCL_PINS);       //SCL=low;
	IIC_Byte<<=1;
    }
    GPIO_WriteHigh(IIC_SDA_PORT,IIC_SDA_PINS);          //SDA=1;
    GPIO_WriteHigh(IIC_SCL_PORT,IIC_SCL_PINS);          //SCL=1;
    GPIO_WriteLow(IIC_SCL_PORT,IIC_SCL_PINS);           //SCL=0;
}

/******************************************************************************
****函数功能：OLED写数据
****输入参数：写的数据
****输出参数：无
******************************************************************************/
void OLED_WriteDat(unsigned char IIC_Data)
{
    GPIO_IIC_Start();
    GPIO_IIC_SendOneByte(0x78);
    GPIO_IIC_SendOneByte(0x40);
    GPIO_IIC_SendOneByte(IIC_Data);
    GPIO_IIC_Stop();
}

/******************************************************************************
****函数功能：OLED写命令
****输入参数：写的命令
****输出参数：无
******************************************************************************/
void OLED_WriteCmd(unsigned char IIC_Command)
{
    GPIO_IIC_Start();
    GPIO_IIC_SendOneByte(0x78);           
    GPIO_IIC_SendOneByte(0x00);			
    GPIO_IIC_SendOneByte(IIC_Command);
    GPIO_IIC_Stop();
}

/******************************************************************************
****函数功能：OLED设置坐标函数
****输入参数：坐标x，y
****输出参数：无
******************************************************************************/
void OLED_SetPos(unsigned char x, unsigned char y) 
{ 
    OLED_WriteCmd(0xb0 + y);
    OLED_WriteCmd(((x & 0xf0) >> 4) | 0x10);
    OLED_WriteCmd((x & 0x0f) | 0x01);
} 

/******************************************************************************
****函数功能：OLED全屏填充
****输入参数：数据指令
****输出参数：无
******************************************************************************/
void OLED_Fill(unsigned char FillData) 
{
    unsigned char y,x;
    for(y = 0; y < 8; y++)
    {
	OLED_WriteCmd(0xb0 + y);
	OLED_WriteCmd(0x01);
	OLED_WriteCmd(0x10);
	for(x = 0;x < X_WIDTH; x++)
	    OLED_WriteDat(FillData);
    }
}

/******************************************************************************
****函数功能：OLED清屏函数
****输入参数：无
****输出参数：无
******************************************************************************/
void OLED_CS(void)
{
    unsigned char y,x;
    for(y = 0; y < 8; y++)
    {
	OLED_WriteCmd(0xb0 + y);
	OLED_WriteCmd(0x01);
	OLED_WriteCmd(0x10);
	for(x = 0; x < X_WIDTH; x++)
	    OLED_WriteDat(0);
    }
}

/******************************************************************************
****函数功能：OLED初始化函数
****输入参数：无
****输出参数：无
******************************************************************************/
void OLED_Init(void)
{
    GPIO_Init(IIC_SCL_PORT, IIC_SCL_PINS, GPIO_MODE_OUT_PP_LOW_FAST);
    GPIO_Init(IIC_SDA_PORT, IIC_SDA_PINS, GPIO_MODE_OUT_PP_LOW_FAST);
  
    delay(500);//初始化之前的延时很重要！
    OLED_WriteCmd(0xae);//--turn off oled panel
    OLED_WriteCmd(0x00);//---set low column address
    OLED_WriteCmd(0x10);//---set high column address
    OLED_WriteCmd(0x40);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
    OLED_WriteCmd(0x81);//--set contrast control register
    OLED_WriteCmd(Brightness); // Set SEG Output Current Brightness
    OLED_WriteCmd(0xa1);//--Set SEG/Column Mapping     0xa0左右反置 0xa1正常
    OLED_WriteCmd(0xc8);//Set COM/Row Scan Direction   0xc0上下反置 0xc8正常
    OLED_WriteCmd(0xa6);//--set normal display
    OLED_WriteCmd(0xa8);//--set multiplex ratio(1 to 64)
    OLED_WriteCmd(0x3f);//--1/64 duty
    OLED_WriteCmd(0xd3);//-set display offset	Shift Mapping RAM Counter (0x00~0x3F)
    OLED_WriteCmd(0x00);//-not offset
    OLED_WriteCmd(0xd5);//--set display clock divide ratio/oscillator frequency
    OLED_WriteCmd(0x80);//--set divide ratio, Set Clock as 100 Frames/Sec
    OLED_WriteCmd(0xd9);//--set pre-charge period
    OLED_WriteCmd(0xf1);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
    OLED_WriteCmd(0xda);//--set com pins hardware configuration
    OLED_WriteCmd(0x12);
    OLED_WriteCmd(0xdb);//--set vcomh
    OLED_WriteCmd(0x40);//Set VCOM Deselect Level
    OLED_WriteCmd(0x20);//-Set Page Addressing Mode (0x00/0x01/0x02)
    OLED_WriteCmd(0x02);//
    OLED_WriteCmd(0x8d);//--set Charge Pump enable/disable
    OLED_WriteCmd(0x14);//--set(0x10) disable
    OLED_WriteCmd(0xa4);// Disable Entire Display On (0xa4/0xa5)
    OLED_WriteCmd(0xa6);// Disable Inverse Display On (0xa6/a7) 
    OLED_WriteCmd(0xaf);//--turn on oled panel
    OLED_Fill(0x00); //初始清屏
    OLED_SetPos(0,0);
} 

/******************************************************************************
****函数功能：OLED显示6*8一组标准ASCII字符串
****输入参数：x、y起始坐标，需要显示的字符
****输出参数：无
******************************************************************************/
void OLED_P6x8Str(unsigned char x, unsigned char y, unsigned char ch[])
{
    unsigned char c = 0, i = 0, j = 0;
    while (ch[j] != '\0')
    {
	c = ch[j] - 32;
	if(x > 126)
        {
            x = 0;
            y++;
        }
	OLED_SetPos(x, y);
	for(i = 0; i < 6; i++)
	    OLED_WriteDat(F6x8[c][i]);
	x += 6;
	j++;
    }
}

/******************************************************************************
****函数功能：OLED显示8*16一组标准ASCII字符串
****输入参数：x、y起始坐标，需要显示的字符
****输出参数：无
******************************************************************************/
void OLED_P8x16Str(unsigned char x,unsigned char y,unsigned char ch[])
{
    unsigned char c = 0, i = 0, j = 0;
    while (ch[j] != '\0')
    {
	c = ch[j] - 32;
	if(x > 120)
        {
            x = 0;
            y++;
        }
	OLED_SetPos(x, y);
	for(i = 0; i < 8; i++)
	    OLED_WriteDat(F8X16[c * 16 + i]);
	OLED_SetPos(x, y + 1);
	for(i = 0; i < 8; i++)
	    OLED_WriteDat(F8X16[c * 16 + i + 8]);
	x += 8;
	j++;
    }
}

/******************************************************************************
****函数功能：OLED显示中文函数
****输入参数：x、y坐标，汉字
****输出参数：无
******************************************************************************/
void OLED_P16x16Ch(unsigned char x,unsigned char y,unsigned char N)
{
    unsigned char wm = 0;
    unsigned int adder = 32 * N;
    OLED_SetPos(x , y);
    for(wm = 0; wm < 16; wm++)
    {
	OLED_WriteDat(F16x16[adder]);
	adder += 1;
    }
    OLED_SetPos(x, y + 1);
    for(wm = 0; wm < 16; wm++)
    {
	OLED_WriteDat(F16x16[adder]);
	adder += 1;
    } 	  	
}

/******************************************************************************
****函数功能：OLED示BMP图片128×64BMP位图
****输入参数：x0、y0起始坐标，x1、y2结束坐标，BMP数据
****输出参数：无
******************************************************************************/
void OLED_DrawBMP(unsigned char x0,unsigned char y0,unsigned char x1,unsigned char y1,const unsigned char BMP[])
{
    unsigned int j = 0;
    unsigned char x, y;

    if(y1 % 8 == 0) 
        y = y1 / 8;      
    else 
        y = y1 / 8 + 1;
    for(y = y0; y < y1; y++)
    {
	OLED_SetPos(x0, y);
        for(x = x0; x < x1; x++)
	{      
	    OLED_WriteDat(BMP[j++]);
	}
    }
}

/******************************************************************************
****函数功能：OLED显示数据 
****输入参数：
****输出参数：无
******************************************************************************/
u16 tn=0;
void Display(void)
{
        
      tn++;
      if(tn==3)
      {
        tn = 0;
          OLED_P8x16Str(80,  4, "     ");//更新界面数值
          OLED_P8x16Str(80,  2, "     ");
          OLED_P8x16Str(32,  4, "     ");
      }
      
      
      
      
      u8 ch[7] ;                         //显示温度
      ch[0] = TempData[0];
      ch[1] = TempData[2]+'0';
      ch[2] = TempData[3]+'0';
      ch[3] = '.';
      ch[4] = TempData[4]+'0';
      ch[5] = TempData[5]+'0';
      ch[6] = '\0';
      temperature_read = TempData[2]*10 + TempData[3]+TempData[4]*0.1+TempData[5]*0.01;




       OLED_P16x16Ch(0, 0, 7);
       OLED_P16x16Ch(16, 0, 8);
       OLED_P16x16Ch(32, 0, 5);
       OLED_P16x16Ch(48, 0, 6);
       OLED_P16x16Ch(64, 0, 13);
       
       OLED_P16x16Ch(0, 2, 9);
       OLED_P16x16Ch(16, 2, 10);
       OLED_P16x16Ch(32, 2, 5);
       OLED_P16x16Ch(48, 2, 6);
       OLED_P16x16Ch(64, 2, 13);
       
       OLED_P16x16Ch(0,  6, 7);
       OLED_P16x16Ch(16, 6, 8);
       OLED_P16x16Ch(32, 6, 11);
       OLED_P16x16Ch(48, 6, 12);
       OLED_P16x16Ch(64, 6, 13);

      
       OLED_P8x16Str(80 , 0, ch);
       OLED_P8x16Str(80,  2, Transform((int)temperature));
       OLED_P8x16Str(80,  4, Transform((int)E));
       
       OLED_P8x16Str(0,   4, Transform(speed));
       OLED_P8x16Str(32,  4, Transform(pwm));
      
       TIM2_SetCompare3(1999); 

         
}


void Oled_init()
{
      CLOCK_Hsi(HSIDIV2, CPUDIV1);
      Delay_Init(8);
      OLED_Init();
      OLED_CS();
}